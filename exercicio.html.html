<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Semana de Treino</title>
  <style>
    :root{
      --azul:#0a2540; /* azul escuro */
      --azul-2:#133b63; /* hover */
      --azul-3:#e6edf5; /* bg suave */
      --branco:#ffffff;
      --cinza:#f5f7fb;
      --texto:#1b2230;
      --ok:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial; background:var(--branco); color:var(--texto)}
    header{background:var(--azul); color:var(--branco); padding:24px 16px; position:sticky; top:0; z-index:10}
    .wrap{max-width:1100px; margin:0 auto}
    h1{margin:0;font-size:24px;letter-spacing:.2px}
    .sub{opacity:.9; font-size:14px}

    .board{display:grid; grid-template-columns:280px 1fr; gap:16px; padding:20px 16px}
    @media (max-width:900px){ .board{grid-template-columns:1fr} }

    .card{background:var(--cinza); border:1px solid #e7ebf3; border-radius:16px; padding:16px}
    .nav .day{display:flex; align-items:center; gap:10px; padding:12px; border-radius:12px; cursor:pointer; user-select:none; transition:.2s; border:1px solid transparent}
    .nav .day:hover{background:var(--azul-3)}
    .nav .day.active{background:var(--azul); color:var(--branco); border-color:transparent}
    .nav .day .status{margin-left:auto; font-size:12px; padding:2px 8px; border-radius:999px; background:#e9eef6; color:#3b4960}
    .nav .day.active .status{background:rgba(255,255,255,.15); color:#fff}
    .nav h3{margin:4px 8px 10px; font-size:14px; text-transform:uppercase; letter-spacing:.12em; color:#4a5b79}

    .activity h2{margin:4px 0 6px; font-size:22px}
    .pill{display:inline-block; font-size:12px; padding:4px 10px; border-radius:999px; background:var(--azul-3); color:#2a3b55; margin-right:8px}
    .goal{font-size:14px; color:#2b3850; background:#eef3fb; border-left:3px solid var(--azul); padding:10px 12px; border-radius:10px; margin:10px 0 14px}

    .row{display:flex; flex-wrap:wrap; gap:12px; align-items:center}
    button{appearance:none; border:none; background:var(--azul); color:var(--branco); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600}
    button.secondary{background:#eaf1fb; color:#18314f}
    button.ghost{background:transparent; color:var(--azul); border:1px solid #cfe0f7}
    button:disabled{opacity:.6; cursor:not-allowed}
    button:hover{background:var(--azul-2)}
    button.secondary:hover{background:#dfe9fb}
    button.ghost:hover{background:#f2f6fd}

    .prompt{background:var(--branco); border:1px solid #e5ecf7; border-radius:12px; padding:12px; margin:10px 0}
    .prompt h4{margin:0 0 6px}
    .meta{font-size:13px; color:#5a6b86}

    .meter{height:10px; background:#e9eff8; border-radius:999px; position:relative; overflow:hidden}
    .meter > span{position:absolute; left:0; top:0; height:100%; background:linear-gradient(90deg,#6aa9ff,#2d6cdf); border-radius:999px; width:0}

    .analysis{display:grid; grid-template-columns:repeat(2,1fr); gap:12px; margin-top:12px}
    @media (max-width:700px){ .analysis{grid-template-columns:1fr} }
    .stat{background:var(--branco); border:1px solid #e5ecf7; border-radius:12px; padding:12px}
    .stat h5{margin:0 0 6px; font-size:13px; color:#3a4b66}
    .tag{display:inline-block; padding:2px 8px; border-radius:999px; background:#eef3fb; font-size:12px; color:#2a3b55}

    .week{display:none}
    .week.show{display:block}

    .summary{background:#f0f6ff; border:1px solid #d8e7ff; border-radius:16px; padding:16px; margin-top:16px}
    .summary h3{margin:0 0 8px}
    .summary ul{margin:6px 0 0 18px}

    .hidden{display:none !important}
    audio{width:100%; margin-top:10px}
    .small{font-size:12px; color:#6b7b95}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <h1>Semana de Treino</h1>
      <div class="sub">Complete as 5 atividades (segunda → sexta). Grave sua fala e receba feedback instantâneo. Ao concluir a semana, veja seu desempenho geral.</div>
    </div>
  </header>

  <main class="wrap board">
    <!-- Navegação lateral (dias) -->
    <aside class="card nav">
      <h3>Atividades da semana</h3>
      <div id="nav-days"></div>
      <div style="margin-top:12px">
        <div class="meter" aria-label="Progresso semanal">
          <span id="progress"></span>
        </div>
        <div class="small" style="margin-top:6px"><span id="done-count">0</span>/5 concluídas</div>
      </div>
      <div style="margin-top:16px">
        <button id="btnWeek" class="ghost" disabled>Ver desempenho da semana</button>
      </div>
    </aside>

    <!-- Área principal da atividade / semana -->
    <section class="card">
      <div id="activity" class="activity"></div>
      <div id="week" class="week"></div>
    </section>
  </main>

  <template id="tpl-activity">
    <div>
      <h2><span class="pill">Dia <span data-field="dia"></span></span> <span data-field="titulo"></span></h2>
      <div class="goal" data-field="descricao"></div>

      <div class="prompt">
        <h4>Desafio de hoje</h4>
        <div class="meta" data-field="prompt"></div>
      </div>

      <div class="row" style="margin:8px 0 6px">
        <button data-act="genPrompt" class="secondary">Sortear novo tema</button>
        <button data-act="startRec">Iniciar gravação</button>
        <button data-act="stopRec" class="ghost" disabled>Parar</button>
        <button data-act="saveRec" class="ghost" disabled>Salvar tentativa</button>
      </div>

      <audio controls class="hidden" data-field="audio"></audio>
      <div class="small" id="timer">⏱️ 00:00</div>

      <div class="analysis">
        <div class="stat"><h5>Duração</h5><div><span class="tag" data-field="dur"></span></div></div>
        <div class="stat"><h5>Palavras & Ritmo</h5><div><span class="tag" data-field="wpm"></span></div></div>
        <div class="stat"><h5>Muletas Verbais</h5><div><span class="tag" data-field="muletas"></span></div></div>
        <div class="stat"><h5>Variação de volume</h5><div><span class="tag" data-field="var"></span></div></div>
      </div>

      <div style="margin-top:12px">
        <button data-act="markDone" disabled>Marcar atividade como concluída</button>
      </div>
    </div>
  </template>

  <template id="tpl-week">
    <div class="summary">
      <h3>Desempenho da semana</h3>
      <p class="small">Resumo gerado a partir das 5 atividades concluídas.</p>
      <div class="analysis">
        <div class="stat"><h5>Tempo médio</h5><div><span class="tag" data-week="tempo"></span></div></div>
        <div class="stat"><h5>Ritmo médio (WPM)</h5><div><span class="tag" data-week="wpm"></span></div></div>
        <div class="stat"><h5>Muletas / min</h5><div><span class="tag" data-week="muletas"></span></div></div>
        <div class="stat"><h5>Consistência de volume</h5><div><span class="tag" data-week="var"></span></div></div>
      </div>
      <h3 style="margin-top:14px">Pontos fortes</h3>
      <ul id="best-list"></ul>
      <h3 style="margin-top:10px">Para melhorar</h3>
      <ul id="improve-list"></ul>
      <h3 style="margin-top:10px">Próximos passos</h3>
      <ul id="todo-list"></ul>
      <div style="margin-top:12px">
        <button id="resetWeek" class="ghost">Reiniciar semana</button>
      </div>
    </div>
  </template>

  <script>
    // ---------------- Configuração das 5 atividades (Seg → Sex) -----------------
    const ACTIVITIES = [
      {
        id: 'seg', dia: 'Segunda', titulo: 'Apresentação de 1 minuto',
        descricao: 'Fale por ~60 segundos sobre um tema proposto. Foque em começo-meio-fim e mantenha o ritmo constante.',
        prompts: [
          'Apresente-se para uma nova turma.',
          'Explique por que um hábito mudou sua vida.',
          'Conte sobre um desafio que você superou.',
          'Descreva um hobby seu para iniciantes.',
          'Fale sobre um lugar que marcou sua memória.'
        ]
      },
      {
        id: 'ter', dia: 'Terça', titulo: 'Palavra Surpresa',
        descricao: 'Crie uma fala usando as 3 palavras sorteadas. Criatividade e conexão entre ideias são o foco.',
        prompts: [
          'chuva, trem, amizade', 'energia, escola, futuro', 'café, viagem, paciência', 'tempo, mapa, escolha', 'livro, ponte, coragem'
        ]
      },
      {
        id: 'qua', dia: 'Quarta', titulo: 'Leitura com Emoção',
        descricao: 'Leia o pequeno texto com a emoção pedida. Varie tom e pausas para transmitir a intenção.',
        prompts: [
          'Texto: "Respire fundo. Toda montanha parece alta antes do primeiro passo." Emoção: encorajamento.',
          'Texto: "Eu esperei tanto por este momento!" Emoção: alegria.',
          'Texto: "Isso não é o fim, é um recomeço." Emoção: esperança.',
          'Texto: "Tenho más notícias." Emoção: seriedade.',
          'Texto: "Ei, tá tudo bem aí?" Emoção: empatia.'
        ]
      },
      {
        id: 'qui', dia: 'Quinta', titulo: 'Resumo Relâmpago (30–45s)',
        descricao: 'Resuma rapidamente um tema. Clareza > detalhes. Objetivo: 80–140 palavras por minuto.',
        prompts: [
          'Resuma um filme que você gosta sem spoilers.',
          'Explique o que é um buraco negro para uma criança.',
          'Resuma como funciona reciclagem na sua cidade.',
          'Explique por que dormir bem melhora a aprendizagem.',
          'Resuma seu dia de ontem em 40s.'
        ]
      },
      {
        id: 'sex', dia: 'Sexta', titulo: 'Perguntas Relâmpago (Q&A)',
        descricao: 'Responda com segurança 3 perguntas sorteadas, mantendo frases curtas e objetivas.',
        prompts: [
          'Qual conselho você daria para você mesmo há 5 anos? | Qual seu maior desafio atual? | O que te motiva a continuar?',
          'Se pudesse aprender algo novo em 1 mês, o que seria? | Como você lida com imprevistos? | Como define sucesso?',
          'O que te deixa nervoso ao falar em público? | Como você se prepara? | Qual falha te ensinou mais?'
        ]
      }
    ];

    const STORAGE_KEY = 'tudofala_semana_v1';

    // ---------------- Estado e utilidades -----------------
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));
    const fmt = (s) => s.toString().padStart(2,'0');

    function loadState(){
      try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || {} }catch(e){ return {} }
    }
    function saveState(st){ localStorage.setItem(STORAGE_KEY, JSON.stringify(st)); }

    const state = loadState();
    if(!state.days){ state.days = {}; }

    // Inicializa estrutura de cada dia
    for(const a of ACTIVITIES){
      if(!state.days[a.id]){
        state.days[a.id] = {done:false, attempts:[], lastPrompt:null, metrics:null};
      }
    }
    saveState(state);

    // ---------------- UI: montar navegação -----------------
    const navEl = document.getElementById('nav-days');
    const progressEl = document.getElementById('progress');
    const doneCountEl = document.getElementById('done-count');
    const btnWeek = document.getElementById('btnWeek');

    function renderNav(activeId){
      navEl.innerHTML = '';
      const doneCount = ACTIVITIES.filter(a=>state.days[a.id].done).length;
      progressEl.style.width = (doneCount/5*100)+'%';
      doneCountEl.textContent = doneCount;
      btnWeek.disabled = doneCount<5;

      for(const a of ACTIVITIES){
        const day = document.createElement('div');
        day.className = 'day'+(a.id===activeId?' active':'');
        day.innerHTML = `
          <div>📅</div>
          <div>
            <div style="font-weight:700">${a.dia}</div>
            <div style="font-size:12px; opacity:.85">${a.titulo}</div>
          </div>
          <span class="status">${state.days[a.id].done? 'Concluída ✅':'Pendente'}</span>
        `;
        day.addEventListener('click',()=>openActivity(a.id));
        navEl.appendChild(day);
      }
    }

    // ---------------- Áudio: gravação e análise -----------------
    let mediaRecorder = null, audioChunks = [], recordingStartedAt = 0, timerInt = null, analyser, audioCtx, sourceNode;

    async function startRecording(){
      const stream = await navigator.mediaDevices.getUserMedia({audio:true});
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      analyser = audioCtx.createAnalyser();
      analyser.fftSize = 2048;
      sourceNode = audioCtx.createMediaStreamSource(stream);
      sourceNode.connect(analyser);

      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.start();
      recordingStartedAt = Date.now();
      startTimer();
    }

    function stopRecording(){
      return new Promise(resolve=>{
        if(!mediaRecorder) return resolve(null);
        mediaRecorder.onstop = async () => {
          const blob = new Blob(audioChunks, {type:'audio/webm'});
          stopTimer();
          resolve(blob);
        };
        mediaRecorder.stop();
        if(sourceNode){try{sourceNode.disconnect();}catch{}}
        if(audioCtx){try{audioCtx.close();}catch{}}
      });
    }

    function startTimer(){
      const timer = document.getElementById('timer');
      timerInt = setInterval(()=>{
        const s = Math.floor((Date.now()-recordingStartedAt)/1000);
        timer.textContent = `⏱️ ${fmt(Math.floor(s/60))}:${fmt(s%60)}`;
      }, 250);
    }
    function stopTimer(){ clearInterval(timerInt); timerInt=null; }

    function getRMS(){
      // mede variação básica de volume durante ~200ms
      if(!analyser) return 0;
      const bufferLength = analyser.fftSize;
      const dataArray = new Uint8Array(bufferLength);
      analyser.getByteTimeDomainData(dataArray);
      let sum = 0;
      for(let i=0;i<bufferLength;i++){
        const v = (dataArray[i]-128)/128; sum += v*v;
      }
      return Math.sqrt(sum/bufferLength);
    }

    // Captura amostras de volume para medir variação
    const volumeSamples = [];
    setInterval(()=>{ if(analyser){ volumeSamples.push(getRMS()); if(volumeSamples.length>300) volumeSamples.shift(); } }, 200);

    // ---------------- Lógica de atividade -----------------
    const activityEl = document.getElementById('activity');
    const weekEl = document.getElementById('week');

    function choosePrompt(a){
      const arr = a.prompts; const pick = arr[Math.floor(Math.random()*arr.length)];
      return pick;
    }

    function analyzeTextFromAudioLength(durationSec, transcriptCandidate){
      // Como não fazemos STT aqui, estimamos pela entrada do usuário no campo opcional
      const text = (transcriptCandidate||'').trim();
      const words = text? text.split(/\s+/).length : Math.round(durationSec*2.0); // estimativa ~2 p/s se sem texto
      const wpm = Math.round(words / (durationSec/60));
      const muletasList = ['é','ééé','ah','ahn','tipo','né','então','uuh','hmm'];
      const muletas = text? (text.toLowerCase().match(new RegExp('\\b(' + muletasList.join('|') + ')\\b','g'))||[]).length : 0;
      const volVar = volumeSamples.length? Number((stddev(volumeSamples)*100).toFixed(1)) : 0; // %
      return {words, wpm, muletas, volVar};
    }

    function stddev(arr){
      if(!arr.length) return 0; const m = arr.reduce((a,b)=>a+b,0)/arr.length; const v = arr.reduce((a,b)=>a+(b-m)**2,0)/arr.length; return Math.sqrt(v);
    }

    function scoreHints({dur, wpm, muletas, volVar}){
      const hints = {best:[], improve:[], next:[]};
      // Duração
      if(dur>=55 && dur<=70){ hints.best.push('Boa precisão de tempo (~1 min).'); }
      else if(dur<50){ hints.improve.push('Fale por mais tempo: mire em ~60s.'); }
      else if(dur>75){ hints.improve.push('Encurte um pouco: tente ~60s.'); }

      // Ritmo
      if(wpm>=90 && wpm<=160){ hints.best.push('Ritmo dentro da faixa recomendada (90–160 WPM).'); }
      else if(wpm<90){ hints.improve.push('Acelere um pouco o ritmo (alvo: 90–160 WPM).'); }
      else { hints.improve.push('Fale um pouco mais devagar (alvo: 90–160 WPM).'); }

      // Muletas
      if(muletas===0){ hints.best.push('Sem muletas verbais. Excelente!'); }
      else if(muletas<=2){ hints.next.push('Reduza ainda mais muletas (treine pausas conscientes).'); }
      else { hints.improve.push('Excesso de muletas: pratique pausas em silêncio.'); }

      // Variação de volume
      if(volVar>=2 && volVar<=6){ hints.best.push('Boa variação de volume (natural).'); }
      else if(volVar<2){ hints.next.push('Projete mais a voz e varie a entonação.'); }
      else { hints.next.push('Estabilize o volume para evitar picos grandes.'); }

      return hints;
    }

    async function openActivity(id){
      weekEl.classList.remove('show');
      activityEl.innerHTML = '';

      const a = ACTIVITIES.find(x=>x.id===id);
      const st = state.days[id];

      const node = document.importNode(document.getElementById('tpl-activity').content, true);
      node.querySelector('[data-field="dia"]').textContent = a.dia;
      node.querySelector('[data-field="titulo"]').textContent = a.titulo;
      node.querySelector('[data-field="descricao"]').textContent = a.descricao;

      // prompt atual
      const promptText = st.lastPrompt || choosePrompt(a);
      st.lastPrompt = promptText; saveState(state);
      node.querySelector('[data-field="prompt"]').textContent = promptText;

      // refs
      const btnGen = node.querySelector('[data-act="genPrompt"]');
      const btnStart = node.querySelector('[data-act="startRec"]');
      const btnStop = node.querySelector('[data-act="stopRec"]');
      const btnSave = node.querySelector('[data-act="saveRec"]');
      const btnDone = node.querySelector('[data-act="markDone"]');
      const audioTag = node.querySelector('[data-field="audio"]');
      const durTag = node.querySelector('[data-field="dur"]');
      const wpmTag = node.querySelector('[data-field="wpm"]');
      const mulTag = node.querySelector('[data-field="muletas"]');
      const varTag = node.querySelector('[data-field="var"]');

      
      // Eventos
      btnGen.addEventListener('click',()=>{ st.lastPrompt = choosePrompt(a); saveState(state); openActivity(id); });

      btnStart.addEventListener('click', async ()=>{
        btnStart.disabled = true; btnStop.disabled = false; btnSave.disabled = true; btnDone.disabled = true; audioTag.classList.add('hidden');
        try{ await startRecording(); }catch(err){ alert('Permita o uso do microfone para gravar.'); btnStart.disabled=false; btnStop.disabled=true; }
      });

      btnStop.addEventListener('click', async ()=>{
        btnStop.disabled = true;
        const blob = await stopRecording();
        if(!blob){ btnStart.disabled=false; return; }
        const url = URL.createObjectURL(blob);
        audioTag.src = url; audioTag.classList.remove('hidden');
        btnSave.disabled = false; btnStart.disabled = false;

        // métricas provisórias
        const dur = Math.round((Date.now()-recordingStartedAt)/1000);
        const transcript = $('#transcript')?.value || '';
        const {wpm, muletas, volVar} = analyzeTextFromAudioLength(dur, transcript);
        durTag.textContent = `${fmt(Math.floor(dur/60))}:${fmt(dur%60)}`;
        wpmTag.textContent = `${wpm} wpm`;
        mulTag.textContent = `${muletas} ocorr.`;
        varTag.textContent = `${volVar}%`;

        // salva tentativa temporária
        st.lastBlob = blob; st.lastMetrics = {dur, wpm, muletas, volVar}; saveState(state);
      });

      btnSave.addEventListener('click', ()=>{
        if(!st.lastBlob){ alert('Grave algo antes de salvar.'); return; }
        const attempt = {
          createdAt: new Date().toISOString(),
          prompt: st.lastPrompt,
          metrics: st.lastMetrics
        };
        st.attempts.push(attempt);
        st.metrics = attempt.metrics; // última válida
        delete st.lastBlob; delete st.lastMetrics;
        saveState(state);
        btnDone.disabled = false;
        alert('Tentativa salva! Você já pode marcar como concluída.');
      });

      btnDone.addEventListener('click', ()=>{
        if(!st.metrics){ alert('Salve uma tentativa antes.'); return; }
        const hints = scoreHints({
          dur: st.metrics.dur,
          wpm: st.metrics.wpm,
          muletas: st.metrics.muletas,
          volVar: st.metrics.volVar
        });
        st.done = true; st.hints = hints; saveState(state);
        renderNav(id);
        alert('Atividade marcada como concluída!');
      });

      activityEl.appendChild(node);
      renderNav(id);
    }

    // ---------------- Semana / Resumo -----------------
    btnWeek.addEventListener('click', ()=> openWeek());

    function openWeek(){
      const allDone = ACTIVITIES.every(a=> state.days[a.id].done);
      if(!allDone){ alert('Conclua as 5 atividades para ver o desempenho.'); return; }
      activityEl.innerHTML = '';
      weekEl.innerHTML = '';

      const node = document.importNode(document.getElementById('tpl-week').content, true);

      // Agregar métricas
      const metrics = ACTIVITIES.map(a=> state.days[a.id].metrics);
      const avg = (k)=> Math.round(metrics.reduce((s,m)=> s+(m?.[k]||0),0)/metrics.length);
      const tempoMedio = avg('dur');
      const wpmMedio = avg('wpm');
      const muletasMedio = Math.round(metrics.reduce((s,m)=> s+(m?.muletas||0),0) / (metrics.reduce((s,m)=> s+(m? m.dur:0),0)/60));
      const varMedio = avg('volVar');

      node.querySelector('[data-week="tempo"]').textContent = `${fmt(Math.floor(tempoMedio/60))}:${fmt(tempoMedio%60)}`;
      node.querySelector('[data-week="wpm"]').textContent = `${wpmMedio} wpm`;
      node.querySelector('[data-week="muletas"]').textContent = `${muletasMedio} / min`;
      node.querySelector('[data-week="var"]').textContent = `${varMedio}%`;

      // Pontos fortes / melhorar a partir dos hints diários
      const best = [], improve = [], next = [];
      for(const a of ACTIVITIES){
        const h = state.days[a.id].hints || {best:[], improve:[], next:[]};
        best.push(...h.best); improve.push(...h.improve); next.push(...h.next);
      }
      const uniq = arr => Array.from(new Set(arr));

      const bestList = node.getElementById('best-list');
      const improveList = node.getElementById('improve-list');
      const todoList = node.getElementById('todo-list');
      for(const t of uniq(best)) addLi(bestList, t, 'ok');
      for(const t of uniq(improve)) addLi(improveList, t, 'bad');
      for(const t of uniq(next)) addLi(todoList, t, 'warn');

      node.getElementById('resetWeek').addEventListener('click', ()=>{
        if(confirm('Tem certeza que deseja reiniciar a semana? Isso apagará o progresso.')){
          localStorage.removeItem(STORAGE_KEY); location.reload();
        }
      });

      weekEl.appendChild(node);
      weekEl.classList.add('show');
      renderNav();
    }

    function addLi(ul, text, type){
      const li = document.createElement('li');
      li.textContent = text;
      li.style.margin = '6px 0';
      if(type==='ok') li.style.color = 'var(--ok)';
      if(type==='warn') li.style.color = 'var(--warn)';
      if(type==='bad') li.style.color = 'var(--bad)';
      ul.appendChild(li);
    }

    // ---------------- Inicialização -----------------
    renderNav('seg');
    openActivity('seg');
  </script>
</body>
</html>